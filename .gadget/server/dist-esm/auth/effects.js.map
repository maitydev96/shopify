{"version":3,"sources":["/var/gadget/codegen/framework-1756630026360-Css7ce/src/auth/effects.ts"],"sourcesContent":["import type { GadgetRecord } from \"@gadgetinc/api-client-core\";\nimport { validateBelongsToLink } from \"../auth.js\";\nimport { FieldType, getActionContextFromLocalStorage } from \"../effects.js\";\nimport { kGlobals } from \"../globals.js\";\nimport type { AnyParams } from \"../types.js\";\n\n/**\n * Applicable for multi-tenant user authenticated apps.\n * Enforces that the given record is only accessible by the current logged in user.\n *\n * For new records: sets the the current session's `userId` to the record.\n * For existing records: Verifies the record objects `userId` matches the one from the current session.\n *\n * @param params - incoming data validated against the current `userId`\n * @param record - record used to validate or set the `userId` on\n * @param {Object} options - Additional options for cross-user validation\n * @param {string} options.userBelongsToField - Specifies which related model is used for cross-user validation.\n */\nexport async function preventCrossUserDataAccess(\n  params: AnyParams,\n  record: GadgetRecord<any>,\n  options?: { userBelongsToField?: string }\n): Promise<void> {\n  const context = getActionContextFromLocalStorage();\n\n  if (context.type != \"effect\") {\n    throw new Error(\"Can't prevent cross user data access outside of an action effect\");\n  }\n  if (!params) {\n    throw new Error(\n      \"The `params` parameter is required in preventCrossUserDataAccess(params, record, options?: { userBelongsToField: string })\"\n    );\n  }\n  if (!record) {\n    throw new Error(\n      \"The `record` parameter is required in preventCrossUserDataAccess(params, record, options?: { userBelongsToField: string })\"\n    );\n  }\n  const model = context.model;\n\n  const userBelongsToField = options?.userBelongsToField;\n\n  // if this effect is not run in the context of a model then it does not apply\n  if (!model) {\n    context.logger.warn(\"preventCrossUserDataAccess: not running in a model action -- will have no effect\");\n    return;\n  }\n\n  const userId: string | undefined = context.session?.get(\"user\");\n  const input = params[model.apiIdentifier];\n\n  const userModel = context.authConfig?.userModelKey\n    ? Object.values(context[kGlobals].modelsMap).find((model) => model.key === context.authConfig?.userModelKey)\n    : undefined;\n\n  const tenantModelKey = userModel?.key ?? \"\";\n  const hasBelongsToField = Object.values(model.fields).some(\n    (f) => f.fieldType === (FieldType.BelongsTo as string) && f.configuration.relatedModelKey === tenantModelKey\n  );\n\n  if (userId && userModel && hasBelongsToField) {\n    validateBelongsToLink({\n      input,\n      record,\n      params,\n      tenantId: userId,\n      model,\n      tenantModelKey,\n      tenantBelongsToField: userBelongsToField,\n      tenantType: \"user\",\n    });\n  }\n}\n"],"names":["validateBelongsToLink","FieldType","getActionContextFromLocalStorage","kGlobals","preventCrossUserDataAccess","params","record","options","context","type","Error","model","userBelongsToField","logger","warn","userId","session","get","input","apiIdentifier","userModel","authConfig","userModelKey","Object","values","modelsMap","find","key","undefined","tenantModelKey","hasBelongsToField","fields","some","f","fieldType","BelongsTo","configuration","relatedModelKey","tenantId","tenantBelongsToField","tenantType"],"mappings":"AACA,SAASA,qBAAqB,QAAQ,aAAa;AACnD,SAASC,SAAS,EAAEC,gCAAgC,QAAQ,gBAAgB;AAC5E,SAASC,QAAQ,QAAQ,gBAAgB;AAGzC;;;;;;;;;;;CAWC,GACD,OAAO,eAAeC,2BACpBC,MAAiB,EACjBC,MAAyB,EACzBC,OAAyC;IAEzC,MAAMC,UAAUN;IAEhB,IAAIM,QAAQC,IAAI,IAAI,UAAU;QAC5B,MAAM,IAAIC,MAAM;IAClB;IACA,IAAI,CAACL,QAAQ;QACX,MAAM,IAAIK,MACR;IAEJ;IACA,IAAI,CAACJ,QAAQ;QACX,MAAM,IAAII,MACR;IAEJ;IACA,MAAMC,QAAQH,QAAQG,KAAK;IAE3B,MAAMC,qBAAqBL,SAASK;IAEpC,6EAA6E;IAC7E,IAAI,CAACD,OAAO;QACVH,QAAQK,MAAM,CAACC,IAAI,CAAC;QACpB;IACF;IAEA,MAAMC,SAA6BP,QAAQQ,OAAO,EAAEC,IAAI;IACxD,MAAMC,QAAQb,MAAM,CAACM,MAAMQ,aAAa,CAAC;IAEzC,MAAMC,YAAYZ,QAAQa,UAAU,EAAEC,eAClCC,OAAOC,MAAM,CAAChB,OAAO,CAACL,SAAS,CAACsB,SAAS,EAAEC,IAAI,CAAC,CAACf,QAAUA,MAAMgB,GAAG,KAAKnB,QAAQa,UAAU,EAAEC,gBAC7FM;IAEJ,MAAMC,iBAAiBT,WAAWO,OAAO;IACzC,MAAMG,oBAAoBP,OAAOC,MAAM,CAACb,MAAMoB,MAAM,EAAEC,IAAI,CACxD,CAACC,IAAMA,EAAEC,SAAS,KAAMjC,UAAUkC,SAAS,IAAeF,EAAEG,aAAa,CAACC,eAAe,KAAKR;IAGhG,IAAId,UAAUK,aAAaU,mBAAmB;QAC5C9B,sBAAsB;YACpBkB;YACAZ;YACAD;YACAiC,UAAUvB;YACVJ;YACAkB;YACAU,sBAAsB3B;YACtB4B,YAAY;QACd;IACF;AACF"}