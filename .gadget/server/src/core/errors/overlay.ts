export const ErrorIconUrl: string = `data:image/svg+xml;base64,${btoa(`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path
    fill-rule="evenodd"
    clip-rule="evenodd"
    d="M5.41064 6.25811L5.41118 6.25864L7.15259 8.00006L5.41083 9.74182C5.35361 9.79696 5.30791 9.86291 5.27638 9.93586C5.24471 10.0091 5.22798 10.088 5.22717 10.1678C5.22636 10.2476 5.24148 10.3268 5.27165 10.4007C5.30183 10.4746 5.34644 10.5418 5.40289 10.5982C5.45933 10.6547 5.52647 10.6993 5.60038 10.7295C5.67428 10.7596 5.75346 10.7747 5.83329 10.7739C5.91311 10.7731 5.99197 10.7564 6.06524 10.7247C6.13819 10.6932 6.20414 10.6475 6.25928 10.5903L8.00104 8.84852L9.74281 10.5903C9.79794 10.6475 9.86389 10.6932 9.93684 10.7247C10.0101 10.7564 10.089 10.7731 10.1688 10.7739C10.2486 10.7747 10.3278 10.7596 10.4017 10.7295C10.4756 10.6993 10.5427 10.6547 10.5992 10.5982C10.6556 10.5418 10.7003 10.4746 10.7304 10.4007C10.7606 10.3268 10.7757 10.2476 10.7749 10.1678C10.7741 10.088 10.7574 10.0091 10.7257 9.93586C10.6942 9.86292 10.6485 9.79696 10.5913 9.74183L8.84949 8.00006L10.5913 6.2583C10.6781 6.17466 10.7377 6.06681 10.7623 5.94878C10.7871 5.8304 10.7754 5.70731 10.729 5.59566C10.6825 5.484 10.6034 5.38898 10.502 5.32307C10.4006 5.25715 10.2817 5.22341 10.1608 5.22626C10.0027 5.23 9.85248 5.29599 9.7428 5.40986L8.00104 7.15161L6.25963 5.41022L6.25908 5.40965C6.20327 5.35233 6.13655 5.30674 6.06285 5.27557C5.98891 5.2443 5.90945 5.22819 5.82917 5.22819H5.82914C5.70974 5.22822 5.59305 5.26387 5.49402 5.33059C5.39499 5.3973 5.31812 5.49205 5.27324 5.6027C5.22836 5.71335 5.21751 5.83488 5.24208 5.95173C5.2666 6.06833 5.32528 6.17499 5.41064 6.25811ZM8.00104 1.2334C4.26983 1.2334 1.23438 4.26886 1.23438 8.00006C1.23438 11.7313 4.26983 14.7667 8.00104 14.7667C11.7322 14.7667 14.7677 11.7313 14.7677 8.00006C14.7677 4.26886 11.7322 1.2334 8.00104 1.2334ZM8.00104 2.4334C11.0814 2.4334 13.5677 4.91976 13.5677 8.00006C13.5677 11.0804 11.0814 13.5667 8.00104 13.5667C4.92073 13.5667 2.43437 11.0804 2.43437 8.00006C2.43437 4.91976 4.92073 2.4334 8.00104 2.4334Z"
    fill="#B13325"
  />
</svg>`)}`;

export const FixIconUrl: string = `data:image/svg+xml;base64,${btoa(`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path
    d="M9.83716 4.62808C10.0977 3.57469 11.5967 3.57467 11.8572 4.62808L12.2908 6.38883C12.9389 9.01279 14.9885 11.0626 17.6126 11.7106L19.3733 12.1457C20.4272 12.406 20.4273 13.904 19.3733 14.1642L17.6126 14.5993C14.9883 15.2474 12.9387 17.2967 12.2908 19.9211L11.8572 21.6818C11.5964 22.7346 10.098 22.7347 9.83716 21.6818L9.40357 19.9211C8.75568 17.2967 6.70603 15.2474 4.08179 14.5993L2.32105 14.1642C1.26703 13.904 1.2672 12.4061 2.32105 12.1457L4.08179 11.7106C6.70573 11.0625 8.75542 9.01274 9.40357 6.38883L9.83716 4.62808ZM18.635 1.78482C18.719 1.44676 19.2001 1.44669 19.2839 1.78482C19.6411 3.23019 20.7696 4.36052 22.2151 4.71744C22.5536 4.8012 22.5538 5.28276 22.2151 5.36637C20.7696 5.72347 19.6409 6.85194 19.2839 8.29752C19.1997 8.63502 18.7192 8.63503 18.635 8.29752C18.2781 6.85173 17.1482 5.72335 15.7024 5.36637C15.3645 5.28248 15.3648 4.80168 15.7024 4.71744C17.148 4.36059 18.2778 3.23027 18.635 1.78482Z"
    fill="url(#paint0_radial_2231_9971)"
  />
  <defs>
    <radialGradient id="paint0_radial_2231_9971" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(1.60523 11.5715) rotate(46.3593) scale(15.0617 14.638)">
      <stop offset="0.015" stop-color="#A259FF"/>
      <stop offset="1" stop-color="#FF597D"/>
    </radialGradient>
  </defs>
</svg>
`)}`;

export const CopyIconUrl: string = `data:image/svg+xml;base64,${btoa(`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path
    d="M5.13385 1.31567C4.61819 1.31567 4.20052 1.73334 4.20052 2.24901V9.71567C4.20052 10.2313 4.61819 10.649 5.13385 10.649H11.2005C11.7162 10.649 12.1339 10.2313 12.1339 9.71567V4.34901C12.1339 4.22534 12.0849 4.10679 11.9971 4.01906L9.43047 1.45239C9.34274 1.36466 9.22419 1.31567 9.10052 1.31567H5.13385ZM8.86719 2.20435L11.2452 4.58234H9.33385C9.07625 4.58234 8.86719 4.37327 8.86719 4.11567V2.20435ZM2.80052 3.64901C2.28485 3.64901 1.86719 4.06667 1.86719 4.58234V12.049C1.86719 12.5647 2.28485 12.9823 2.80052 12.9823H8.86719C9.38285 12.9823 9.80052 12.5647 9.80052 12.049V11.5823H5.13385C4.10439 11.5823 3.26719 10.7451 3.26719 9.71567V3.64901H2.80052Z"
    fill="black"
  />
</svg>`)}`;

export const ChevronRightIconUrl: string = `data:image/svg+xml;base64,${btoa(`<svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M5.62439 2.45284C5.52986 2.41298 5.4283 2.39248 5.32572 2.39258C5.17327 2.39277 5.0243 2.4384 4.89791 2.52364C4.77152 2.60888 4.67341 2.72987 4.61611 2.87114C4.55882 3.01242 4.54493 3.16756 4.57624 3.31676C4.6075 3.46573 4.68239 3.60203 4.79137 3.70828L9.58217 8.49909L4.79161 13.2897C4.71838 13.3602 4.6599 13.4445 4.61957 13.5378C4.5791 13.6315 4.55772 13.7322 4.55668 13.8342C4.55564 13.9362 4.57497 14.0374 4.61352 14.1318C4.65208 14.2263 4.70909 14.3121 4.78121 14.3842C4.85334 14.4563 4.93913 14.5133 5.03357 14.5519C5.128 14.5904 5.22918 14.6098 5.33118 14.6087C5.43317 14.6077 5.53394 14.5863 5.62757 14.5458C5.72087 14.5055 5.80522 14.447 5.87572 14.3738L11.2084 9.04114C11.3521 8.89736 11.4328 8.70238 11.4328 8.49909C11.4328 8.29579 11.3521 8.10081 11.2084 7.95702L5.8755 2.62416C5.80407 2.55087 5.71869 2.49262 5.62439 2.45284Z" fill="#6F6C71"/>
</svg>`)}`;

export const InconsolataFont = /* css */ `
:root {
  --inconsolata: Gadget-Inconsolata-Private, sans-serif;
  font-family: var(--inconsolata);
}
  /* vietnamese */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyxq15IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323,
    U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyx615IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
    U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 400;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyya15IDhunA.woff2) format("woff2");
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
    U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* vietnamese */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 500;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyxq15IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323,
    U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 500;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyx615IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
    U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 500;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyya15IDhunA.woff2) format("woff2");
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
    U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* vietnamese */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 600;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyxq15IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323,
    U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 600;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyx615IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
    U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 600;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyya15IDhunA.woff2) format("woff2");
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
    U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* vietnamese */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 700;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyxq15IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323,
    U+0329, U+1EA0-1EF9, U+20AB;
}
/* latin-ext */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 700;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyx615IDhunJ_o.woff2) format("woff2");
  unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F,
    U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
/* latin */
@font-face {
  font-family: "Gadget-Inconsolata-Private";
  font-style: normal;
  font-weight: 700;
  font-stretch: 100%;
  font-display: swap;
  src: url(https://fonts.gstatic.com/s/inconsolata/v32/QlddNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmAwLyya15IDhunA.woff2) format("woff2");
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122,
    U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
`;

interface BackendErrorOverlay {
  style: "backendError";
  errorMessage: string;
  traceId: string;
  traceIdLogLink: string;
  environmentSlug: string;
  environmentId: string;
}

interface ViteFrontendOverlay {
  style: "viteFrontend";
}

interface RR7Overlay {
  style: "rr7Frontend";
  errorMessage: string;
  stackTrace?: string;
  environmentSlug: string;
}

type Overlay = BackendErrorOverlay | ViteFrontendOverlay | RR7Overlay;

const baseStyle = /* css */ `

gadget-dev-harness {
  display: none;
}

.window {
  font-family: var(--inconsolata);
  line-height: 1.5;
  max-width: 80vw;
  box-sizing: border-box;
  margin: 30px auto;
  position: relative;
  border-radius: 6px 6px 8px 8px;
  box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
  overflow: hidden;
  direction: ltr;
  text-align: left;
  outline: 1px #db3927 solid;
  outline-offset: -1px;
}

.error-overlay {
  font-family: var(--inconsolata);
  width: 100%;
  background: white;
  overflow: hidden;
  border-radius: 8px;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 16px;
  display: inline-flex;
}

.error-container {
  align-self: stretch;
  background: white;
  overflow: hidden;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  display: flex;
}

.error-content {
  align-self: stretch;
  padding: 12px;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 12px;
  display: flex;
  max-height: 90vh;
  overflow: auto;
}

.error-header {
  align-self: stretch;
  position: relative;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 10px;
  display: flex;
}

.error-title-row {
  align-self: stretch;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 8px;
  display: inline-flex;
}

.error-icon-wrapper {
  padding-top: 2px;
  padding-bottom: 2px;
  justify-content: flex-start;
  align-items: center;
  gap: 10px;
  display: flex;
}

.error-title pre {
  margin: 0;
  white-space: pre-wrap;
  font-family: inherit;
  font-size: inherit;
  font-weight: inherit;
  color: inherit;
}

.error-icon {
  width: 16px;
  height: 16px;
  position: relative;
  overflow: hidden;
}

.error-details {
  align-self: stretch;
  background: #f6f6f6;
  border-radius: 8px;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
  display: flex;
}

.error-details-content {
  align-self: stretch;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 10px;
  display: flex;
}

.error-file-path {
  align-self: stretch;
  color: #2d53b1;
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
  word-wrap: break-word;
  cursor: pointer;
}

.error-file-path:hover {
  text-decoration: underline;
}

.error-message {
  align-self: stretch;
  color: black;
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
  word-wrap: break-word;
}

.error-stack {
  align-self: stretch;
  padding: 8px 12px;
  overflow: hidden;
  border-radius: 8px;
  outline: 1px #cbcbcb solid;
  outline-offset: -1px;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 12px;
  display: inline-flex;
}

.error-stack-content {
  flex: 1 1 0;
  align-self: stretch;
  color: #545454;
  font-size: 12px;
  font-weight: 500;
  line-height: 16px;
  word-wrap: break-word;
}

.standard-button{
  height: 24px;
  display: inline-flex;
  padding: var(--scale-scale200, 6px);
  justify-content: center;
  align-items: center;
  gap: var(--scale-scale300, 8px);
  border-radius: var(--radius-button-radius, 6px);
  border: 1px solid var(--gray-gray300, #CBCBCB);
  background: var(--neutral-Background, #FFF);
  box-shadow: 0px -1px 0px 0px rgba(0, 0, 0, 0.24) inset, 0px 1px 1px 0px rgba(0, 0, 0, 0.16);
}
.standard-button:hover{
  border: 1px solid var(--gray-gray300, #CBCBCB);
  background: var(--gray-gray50, #F6F6F6);
}
.standard-button:active:not(:disabled){
  border: 1px solid var(--gray-gray200, #E2E2E2);
  background: var(--gray-gray50, #F6F6F6);
  box-shadow: -1px 0px 1px 0px rgba(0, 0, 0, 0.08) inset, 1px 0px 1px 0px rgba(0, 0, 0, 0.08) inset, 0px 2px 2px 0px rgba(0, 0, 0, 0.16) inset;
}

.error-fix-button {
  display: inline-flex;
  height: 24px;
  padding: 4px 8px 4px 6px;
  justify-content: center;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
  border-radius: var(--radius-button-radius, 6px);
  border: 1px solid #C99EFF;
  background: #FFF;
  box-shadow: 0px -1px 0px 0px rgba(0, 0, 0, 0.24) inset, 0px 1px 1px 0px rgba(0, 0, 0, 0.16);
  cursor: pointer;
  margin-left: auto;
}

.error-fix-button:hover {
  border: 1px solid #E786B2;
  background: #FBF5F8;
}

.error-fix-button:active:not(:disabled){
  transform: translateY(1px);
  border: 1px solid #FBDBE9;
  background: #FBF5F8;
  box-shadow: -1px 0px 1px 0px rgba(0, 0, 0, 0.08) inset, 1px 0px 1px 0px rgba(0, 0, 0, 0.08) inset, 0px 2px 2px 0px rgba(0, 0, 0, 0.16) inset;
}

.error-fix-icon {
  width: 16px;
  height: 16px;
  position: relative;
  overflow: hidden;
}

.error-fix-icon-gradient {
  width: 12.94px;
  height: 13.34px;
  left: 1.45px;
  top: 1.6px;
  position: absolute;
  background: radial-gradient(ellipse 71.93% 69.94% at 0.36% 47.95%, #a259ff 1%, #ff597d 100%);
}

.error-fix-text {
  color: #9b2e84;
  font-size: 14px;
  font-family: var(--inconsolata);
  font-weight: 500;
  line-height: 20px;
  word-wrap: break-word;
}

.message {
  white-space: pre-wrap;
}

.error-title pre {
  margin: 0;
  white-space: pre-wrap;
  flex: 1 1 0;
  justify-content: center;
  display: flex;
  flex-direction: column;
  color: #b13325;
  font-size: 14px;
  font-family: var(--inconsolata);
  font-weight: 700;
  line-height: 20px;
  word-wrap: break-word;
}

.error-content-text {
  flex: 1 1 0;
  align-self: stretch;
  color: #000;
  font-size: 14px;
  font-weight: 500;
  line-height: 20px;
  word-wrap: break-word;
  word-break: break-word;
  white-space: pre-wrap;
  font-family: var(--inconsolata);
}

.error-trace-id-content-box {
  width: 100%;
  box-sizing: border-box;
  padding-left: 12px;
  padding-right: 12px;
  padding-top: 8px;
  padding-bottom: 8px;
  border-radius: 6px;
  outline: 1px var(--gray-alpha-alpha300, rgba(0, 0, 0, 0.20)) solid;
  outline-offset: -1px;
  justify-content: space-between;
  align-items: center;
  display: inline-flex;
  cursor: pointer;
}

.error-trace-id-content-box:hover {
  background-color: var(--gray-alpha-alpha100, rgb(241, 241, 241));
}

.error-trace-id-content-box:active:not(:disabled) > * {
  transform: translateY(1px);
}

.error-trace-id-content {
  flex: 1 1 0;
  justify-content: flex-start;
  align-items: center;
  gap: 6px;
  display: flex;
}

.error-stack-trace-content-box {
  background: var(--gray-alpha-alpha50, rgba(0, 0, 0, 0.03));
  padding: 12px;
  border-radius: 8px;
  width: 100%;
  box-sizing: border-box;
  height: 100%;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 12px;
  display: inline-flex;
}

.error-stack-trace-content {
  flex: 1 1 0;
  align-self: stretch;
  color: var(--gray-gray600, #545454);
  font-size: 12px;
  font-weight: 500;
  line-height: 16px;
  word-wrap: break-word;
  white-space: pre-wrap;
  font-family: var(--inconsolata);
}
`;

export const Style = (overlayStyle: Pick<Overlay, "style">): string => {
  const style: string[] = [];

  switch (overlayStyle.style) {
    case "backendError":
    case "rr7Frontend":
      style.push(`
body {
  background: #515151;
}`);
      break;
    case "viteFrontend":
      style.push(`
:host {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 99999;
  --inconsolata: Gadget-Inconsolata-Private, sans-serif;
      background: #515151;
}`);
      break;
  }

  return InconsolataFont + style.join("\n") + baseStyle;
};

const getErrorMessage = (overlayStyle: Overlay) => {
  let errorMessage = "";

  switch (overlayStyle.style) {
    case "backendError": {
      errorMessage = `${overlayStyle.errorMessage}\n\nTrace ID: ${overlayStyle.traceId}`;
      break;
    }
    case "rr7Frontend": {
      errorMessage = `${overlayStyle.stackTrace}`;
      break;
    }
    default: {
      errorMessage = ``;
      break;
    }
  }

  return errorMessage.replaceAll("`", "\\`");
};

export const checkIfInGadgetIFrame = (): Promise<boolean> => {
  return new Promise<boolean>((resolve) => {
    const handleMessage = (event: MessageEvent) => {
      if (event.data?.type === "gadget:pong") {
        resolve(true);
        window.removeEventListener("message", handleMessage);
      }
    };

    window.addEventListener("message", handleMessage);

    window.parent.postMessage({ type: "gadget:ping" }, "*");

    setTimeout(() => {
      resolve(false);
      window.removeEventListener("message", handleMessage);
    }, 100);
  });
};

export const overlayTemplate = (overlay: Overlay) => {
  const aiFixButton = /*html*/ `
    <button class="error-fix-button">
      <img src="${FixIconUrl}" alt="Fix icon" width="16" height="16" />
      <div class="error-fix-text">Fix</div>
    </button>`;

  const getErrorTitleText = (overlayStyle: Overlay) => {
    switch (overlayStyle.style) {
      case "backendError":
        return "Unexpected server-side error";
      case "viteFrontend":
        return "Vite hot reload error";
      case "rr7Frontend":
        return "React router server-side rendering error";
      default:
        return "Unexpected error";
    }
  };

  const maybeGetTraceIdLinkComponent = (overlayStyle: Overlay) => {
    if (overlayStyle.style !== "backendError") {
      return "";
    }

    return /* html */ `
      <div class="error-trace-id-content-box">
        <div class="error-trace-id-content">
            <div style="color: var(--gray-alpha-alpha600, rgba(0, 0, 0, 0.67)); font-size: 14px; font-weight: 500; line-height: 20px; word-wrap: break-word">traceID: ${
              overlayStyle.traceId
            }</div>
        </div>
        <img src="${ChevronRightIconUrl}" alt="Chevron right icon" width="16" height="16" />
      </div>
      ${maybeGetErrorMessageComponent(overlayStyle)}`;
  };

  const maybeGetErrorMessageComponent = (overlayStyle: Overlay) => {
    if (!("errorMessage" in overlayStyle && overlayStyle.errorMessage)) {
      return "";
    }

    return /* html */ `
      <div class="error-stack-trace-content-box">
        <div class="error-content-text">${overlayStyle.errorMessage}</div>
        ${aiFixButton}
      </div>`;
  };

  const maybeGetErrorDetailsContentComponent = (overlayStyle: Overlay) => {
    if (overlayStyle.style !== "viteFrontend") {
      return "";
    }

    return /* html */ `
      <div class="error-stack-trace-content-box">
        <div class="error-details-content">
          <div id="error-message-file" class="error-content-text"></div>
          <div id="error-message" class="error-content-text"></div>
        </div>
        ${aiFixButton}
      </div>
      `;
  };

  const copyButton = (textToCopy: string) => {
    // TODO - Add this to the stack trace when we can reliably know that we have the permission to copy from the browser available
    return /* html */ `
      <button class="standard-button" onclick="navigator.clipboard.writeText(\`${textToCopy.replace(/'/g, "\\'")}\`)">
        <img src="${CopyIconUrl}" alt="Copy icon" width="16" height="16" />
      </button>`;
  };

  const maybeGetStackTraceComponent = (overlayStyle: Overlay) => {
    if (overlayStyle.style !== "rr7Frontend") {
      return "";
    }

    return /* html */ `
      <div class="error-stack-trace-content-box">
        <div class="error-stack-trace-content">${overlayStyle.stackTrace}</div>
        ${aiFixButton}
      </div>`;
  };

  return {
    html: /* html */ `
<style>${Style(overlay)}</style>

<div class="window">
  <div class="error-overlay">
    <div class="error-container">
      <div class="error-content">
        <div class="error-header">
          <div class="error-title-row">
            <div class="error-icon-wrapper">
              <div class="error-icon">
              <img src="${ErrorIconUrl}" alt="Error icon" width="16" height="16" />
              </div>
            </div>
            <div class="error-title">
              <pre id="plugin-message">${getErrorTitleText(overlay)}</pre>
            </div>
          </div>
        </div>

        ${maybeGetTraceIdLinkComponent(overlay)}
        ${maybeGetErrorDetailsContentComponent(overlay)}
        ${maybeGetStackTraceComponent(overlay)}


      </div>
    </div>
  </div>
</div>`,
    javascript: /* js */ `
    const checkIfInGadgetIFrame = () => {
      return new Promise((resolve) => {
        const handleMessage = (event) => {
          if (event.data?.type === "gadget:pong") {
            resolve(true);
            window.removeEventListener("message", handleMessage);
          }
        };

        window.addEventListener("message", handleMessage);

        window.parent.postMessage({ type: "gadget:ping" }, "*");

        setTimeout(() => {
          resolve(false);
          window.removeEventListener("message", handleMessage);
        }, 100);
      });
    };

    window?.parent?.postMessage({
      type: "gadget:error-overlay-shown",
      overlay: ${JSON.stringify(overlay)},
    }, "*");

    ${
      overlay.style !== "viteFrontend"
        ? `
  console.debug("[Gadget-Error-Overlay] Rendering error overlay");

  const errorMessage = \`${getErrorMessage(overlay)}\`;

  const fixButton = document.querySelector(".error-fix-button");
  if (fixButton) {
    console.debug("[Gadget-Error-Overlay] Fix button found attaching event listener");
    const prompt = "Fix the following error:\\n\\n" + errorMessage;

    fixButton.addEventListener("click", () => {

      // Use the check
      checkIfInGadgetIFrame().then((isInGadgetIFrame) => {
        if (isInGadgetIFrame) {
          console.debug("[Gadget-Error-Overlay] Opening error from iframe");
          window.parent.postMessage({ type: "gadget:prompt", prompt }, "*");
        } else {
          console.debug("[Gadget-Error-Overlay] Opening error in new tab");
          fetch(window.location.origin + "/api/zprompt", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt })
          })
            .then(response => response.json())
            .then(payload => {
              window.open(
                window.location.origin + "/edit?promptId=" + encodeURIComponent(payload.id),
                window.self === window.top ? "_top" : "_blank"
              );
            })
            .catch(error => {
              console.error("[Gadget-Error-Overlay] Error sending prompt:", error);
            });
        }
      }).catch((err) => {
        console.error("[Gadget-Error-Overlay] Error firing fix button event", err);
      });
    });
  } else {
    console.error("[Gadget-Error-Overlay] Fix button not found");
  }

  ${
    overlay.style === "backendError"
      ? /* html */ `
  const traceIdButton = document.querySelector(".error-trace-id-content-box");
  if (traceIdButton) {
    traceIdButton.addEventListener("click", () => {
      checkIfInGadgetIFrame().then((isInGadgetIFrame) => {
        if (isInGadgetIFrame) {
          console.debug("[Gadget-Error-Overlay] Sending open logs message from iframe");
          window.parent.postMessage({ type: "gadget:openLogs", traceId: "${overlay.traceId}" }, "*");
        } else {
          console.debug("[Gadget-Error-Overlay] Opening trace ID log link");
          window.open(\`${overlay.traceIdLogLink}\`, window.self === window.top ? "_top" : "_blank"); // open in top if in iframe, otherwise open in new tab
        }
      }).catch((err) => {
        console.error("[Gadget-Error-Overlay] Error opening trace ID log link", err);
      });
    });
  } else {
    console.error("[Gadget-Error-Overlay] Trace ID button not found");
  }
  `
      : ""
  }`
        : ""
    }

    `,
  };
};

declare const currentEnvironment: string;
// Make HTMLElement available in non-browser environments
const { HTMLElement = class {} as typeof globalThis.HTMLElement } = globalThis;
class ErrorOverlay extends HTMLElement {
  root: ShadowRoot;

  constructor(err: any) {
    super();
    this.root = this.attachShadow({ mode: "open" });
    this.root.innerHTML = overlayTemplate({ style: "viteFrontend" }).html;
    this.dir = "ltr";

    const errorLine = err.loc?.line;
    const errorColumn = err.loc?.column;

    const [file] = (err.loc?.file || err.id || "unknown").split(`?`);
    let fileText;
    if (err.loc) {
      fileText = `${file}:${errorLine}:${errorColumn}`;
    } else if (err.id) {
      fileText = file;
    } else {
      fileText = "unknown";
    }

    let fileLink: HTMLDivElement | null = null;
    const gadgetFolderMatch = file.match(/\/(web|api)\/(.+)/);
    if (gadgetFolderMatch) {
      const filePathForLink = gadgetFolderMatch ? `${gadgetFolderMatch[1]}/${gadgetFolderMatch[2]}` : file;

      const locationQueryParam =
        errorLine !== undefined && errorColumn !== undefined ? `?startLineNumber=${errorLine}&startColumn=${errorColumn}&force=1` : "";

      if (window.self !== window.top) {
        const filePathButton = this.root.querySelector(".error-file-path");
        if (filePathButton) {
          filePathButton.addEventListener("click", () => {
            checkIfInGadgetIFrame()
              .then((isInGadgetIFrame) => {
                if (isInGadgetIFrame) {
                  window.parent.postMessage({ type: "gadget:openFile", filePath: filePathForLink }, "*");
                } else {
                  window.open(
                    `${window.location.origin}/edit/${currentEnvironment}/files/${filePathForLink}${locationQueryParam}`,
                    window.self === window.top ? "_top" : "_blank"
                  );
                }
              })
              .catch((err) => {
                console.error("[Gadget-Error-Overlay] Error opening file", err);
              });
          });
        }
      } else {
        fileLink = this.createLink(
          `${fileText}`,
          `${window.location.origin}/edit/${currentEnvironment}/files/${filePathForLink}${locationQueryParam}`
        );
      }
    }

    const errorMessage = err.message.trim();
    this.text("#error-message", errorMessage);
    this.text("#error-message-file", fileLink?.innerHTML ?? fileText, true);

    const fixButton = this.root.querySelector(".error-fix-button");
    if (fixButton) {
      fixButton.addEventListener("click", () => {
        checkIfInGadgetIFrame()
          .then((isInGadgetIFrame) => {
            if (isInGadgetIFrame) {
              window.parent.postMessage({ type: "gadget:prompt", prompt: err.message }, "*");
            } else {
              fetch(window.location.origin + "/api/zprompt", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ prompt: `Fix the following error:\n\n${err.message}` }),
              })
                .then((response) => response.json())
                .then((payload) => {
                  window.open(`${window.location.origin}/edit?promptId=${payload.id}`, window.self === window.top ? "_top" : "_blank");
                })
                .catch((error) => {
                  console.error("[Gadget-Error-Overlay] Error sending prompt:", error);
                });
            }
          })
          .catch((err) => {
            console.error("[Gadget-Error-Overlay] Error firing fix button event", err);
          });
      });
    } else {
      console.error("fix button not found");
    }
  }

  text(selector: string, text: string | undefined, html = false): void {
    if (!text) {
      return;
    }

    const el = this.root.querySelector(selector);

    if (!el) {
      return;
    }

    if (html) {
      // Automatically detect links
      text = text
        .split(" ")
        .map((v) => {
          if (!v.startsWith("https://")) return v;
          if (v.endsWith(".")) return `<a target="_blank" href="${v.slice(0, -1)}">${v.slice(0, -1)}</a>.`;
          return `<a target="_blank" href="${v}">${v}</a>`;
        })
        .join(" ");

      el.innerHTML = text.trim();
    } else {
      el.textContent = text.trim();
    }
  }

  createLink(text: string, href: string | undefined): HTMLDivElement {
    const linkContainer = document.createElement("div");
    const linkElement = href ? document.createElement("a") : document.createElement("button");
    linkElement.innerHTML = text;

    if (href && linkElement instanceof HTMLAnchorElement) {
      linkElement.href = href;
      linkElement.target = "_blank";
    }

    linkContainer.appendChild(linkElement);
    linkContainer.className = "link";

    return linkContainer;
  }

  close(): void {
    this.parentNode?.removeChild(this);
  }
}

function getOverlayCode(environment: string) {
  return `
    const baseStyle = \`${baseStyle}\`;
    const ChevronRightIconUrl = "${ChevronRightIconUrl}";
    const ErrorIconUrl = "${ErrorIconUrl}";
    const FixIconUrl = "${FixIconUrl}";
    const InconsolataFont = \`${InconsolataFont}\`;
    const getErrorMessage = ${getErrorMessage};
    const Style = ${Style};
		const overlayTemplate = ${overlayTemplate};
    const currentEnvironment = "${environment}";
    const checkIfInGadgetIFrame = ${checkIfInGadgetIFrame};
		${ErrorOverlay.toString()}
	`;
}

export function patchOverlay(code: string, environment: string): string {
  let result = code.replace("class ErrorOverlay", getOverlayCode(environment) + "\nclass ViteErrorOverlay");
  result = result.replace('_define_property()._(this, "root", void 0);', "");

  return result;
}
