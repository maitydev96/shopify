{"version":3,"sources":["../effects.ts"],"sourceRoot":"","sourcesContent":["import type { GadgetRecord } from \"@gadgetinc/api-client-core\";\nimport { validateBelongsToLink } from \"../auth\";\nimport { FieldType, getActionContextFromLocalStorage } from \"../effects\";\nimport { kGlobals } from \"../globals\";\nimport type { AnyParams } from \"../types\";\n\n/**\n * Applicable for multi-tenant user authenticated apps.\n * Enforces that the given record is only accessible by the current logged in user.\n *\n * For new records: sets the the current session's `userId` to the record.\n * For existing records: Verifies the record objects `userId` matches the one from the current session.\n *\n * @param params - incoming data validated against the current `userId`\n * @param record - record used to validate or set the `userId` on\n * @param {Object} options - Additional options for cross-user validation\n * @param {string} options.userBelongsToField - Specifies which related model is used for cross-user validation.\n */\nexport async function preventCrossUserDataAccess(\n  params: AnyParams,\n  record: GadgetRecord<any>,\n  options?: { userBelongsToField?: string }\n): Promise<void> {\n  const context = getActionContextFromLocalStorage();\n\n  if (context.type != \"effect\") {\n    throw new Error(\"Can't prevent cross user data access outside of an action effect\");\n  }\n  if (!params) {\n    throw new Error(\n      \"The `params` parameter is required in preventCrossUserDataAccess(params, record, options?: { userBelongsToField: string })\"\n    );\n  }\n  if (!record) {\n    throw new Error(\n      \"The `record` parameter is required in preventCrossUserDataAccess(params, record, options?: { userBelongsToField: string })\"\n    );\n  }\n  const model = context.model;\n\n  const userBelongsToField = options?.userBelongsToField;\n\n  // if this effect is not run in the context of a model then it does not apply\n  if (!model) {\n    context.logger.warn(\"preventCrossUserDataAccess: not running in a model action -- will have no effect\");\n    return;\n  }\n\n  const userId: string | undefined = context.session?.get(\"user\");\n  const input = params[model.apiIdentifier];\n\n  const userModel = context.authConfig?.userModelKey\n    ? Object.values(context[kGlobals].modelsMap).find((model) => model.key === context.authConfig?.userModelKey)\n    : undefined;\n\n  const tenantModelKey = userModel?.key ?? \"\";\n  const hasBelongsToField = Object.values(model.fields).some(\n    (f) => f.fieldType === (FieldType.BelongsTo as string) && f.configuration.relatedModelKey === tenantModelKey\n  );\n\n  if (userId && userModel && hasBelongsToField) {\n    validateBelongsToLink({\n      input,\n      record,\n      params,\n      tenantId: userId,\n      model,\n      tenantModelKey,\n      tenantBelongsToField: userBelongsToField,\n      tenantType: \"user\",\n    });\n  }\n}\n"],"names":["preventCrossUserDataAccess","params","record","options","context","getActionContextFromLocalStorage","type","Error","model","userBelongsToField","logger","warn","userId","session","get","input","apiIdentifier","userModel","authConfig","userModelKey","Object","values","kGlobals","modelsMap","find","key","undefined","tenantModelKey","hasBelongsToField","fields","some","f","fieldType","FieldType","BelongsTo","configuration","relatedModelKey","validateBelongsToLink","tenantId","tenantBelongsToField","tenantType"],"mappings":";;;;+BAkBsBA;;;eAAAA;;;sBAjBgB;yBACsB;yBACnC;AAelB,eAAeA,2BACpBC,MAAiB,EACjBC,MAAyB,EACzBC,OAAyC;IAEzC,MAAMC,UAAUC,IAAAA,yCAAgC;IAEhD,IAAID,QAAQE,IAAI,IAAI,UAAU;QAC5B,MAAM,IAAIC,MAAM;IAClB;IACA,IAAI,CAACN,QAAQ;QACX,MAAM,IAAIM,MACR;IAEJ;IACA,IAAI,CAACL,QAAQ;QACX,MAAM,IAAIK,MACR;IAEJ;IACA,MAAMC,QAAQJ,QAAQI,KAAK;IAE3B,MAAMC,qBAAqBN,SAASM;IAEpC,6EAA6E;IAC7E,IAAI,CAACD,OAAO;QACVJ,QAAQM,MAAM,CAACC,IAAI,CAAC;QACpB;IACF;IAEA,MAAMC,SAA6BR,QAAQS,OAAO,EAAEC,IAAI;IACxD,MAAMC,QAAQd,MAAM,CAACO,MAAMQ,aAAa,CAAC;IAEzC,MAAMC,YAAYb,QAAQc,UAAU,EAAEC,eAClCC,OAAOC,MAAM,CAACjB,OAAO,CAACkB,iBAAQ,CAAC,CAACC,SAAS,EAAEC,IAAI,CAAC,CAAChB,QAAUA,MAAMiB,GAAG,KAAKrB,QAAQc,UAAU,EAAEC,gBAC7FO;IAEJ,MAAMC,iBAAiBV,WAAWQ,OAAO;IACzC,MAAMG,oBAAoBR,OAAOC,MAAM,CAACb,MAAMqB,MAAM,EAAEC,IAAI,CACxD,CAACC,IAAMA,EAAEC,SAAS,KAAMC,kBAAS,CAACC,SAAS,IAAeH,EAAEI,aAAa,CAACC,eAAe,KAAKT;IAGhG,IAAIf,UAAUK,aAAaW,mBAAmB;QAC5CS,IAAAA,2BAAqB,EAAC;YACpBtB;YACAb;YACAD;YACAqC,UAAU1B;YACVJ;YACAmB;YACAY,sBAAsB9B;YACtB+B,YAAY;QACd;IACF;AACF"}