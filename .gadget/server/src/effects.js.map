{"version":3,"sources":["../effects.ts"],"sourceRoot":"","sourcesContent":["import type { AnyClient, InternalModelManager, RecordData } from \"@gadgetinc/api-client-core\";\nimport { ChangeTracking, GadgetRecord } from \"@gadgetinc/api-client-core\";\nimport { InternalError, InvalidStateTransitionError, NoSessionForAuthenticationError, UserNotSetOnSessionError } from \"./errors\";\nimport { Globals, actionContextLocalStorage, kGlobals } from \"./globals\";\nimport { frameworkVersion, modelListIndex, modelsMap } from \"./metadata\";\nimport type {\n  AnyActionContext,\n  AnyAmbientContext,\n  AnyEffectContext,\n  AnyGlobalActionContext,\n  AnyParams,\n  ModelMetadata,\n  NotYetTyped,\n} from \"./types\";\nimport { assert } from \"./utils\";\n\nexport function getBelongsToRelationParams(model: ModelMetadata, params: Record<string, any>): Record<string, any> {\n  const belongsToParams: Record<string, any> = {};\n\n  for (const field of Object.values(model.fields) as any[]) {\n    if (field.fieldType != \"BelongsTo\") continue;\n    const modelParams = typeof params[model.apiIdentifier] === \"object\" ? params[model.apiIdentifier] : undefined;\n    const belongsToParam =\n      modelParams && typeof modelParams[field.apiIdentifier] === \"object\" ? modelParams[field.apiIdentifier] : undefined;\n    const belongsToId = belongsToParam?.[LINK_PARAM] !== undefined ? belongsToParam[LINK_PARAM] : belongsToParam?.id;\n    if (belongsToId !== undefined) {\n      belongsToParams[`${field.apiIdentifier}Id`] = belongsToId;\n    }\n  }\n\n  return belongsToParams;\n}\n\nexport function createGadgetRecord<Shape>(apiIdentifier: string, data: Shape): GadgetRecord<Shape & { __typename: string }> {\n  const model = getModelByApiIdentifier(apiIdentifier);\n  return new GadgetRecord({\n    ...data,\n    __typename: model.graphqlTypeName,\n  });\n}\n\n/**\n * Applies incoming API params (your modelâ€™s fields) to a record\n *\n * @param params - data passed from API calls, webhook events, or direct user inputs.\n * @param record - object used to pass params to\n */\nexport function applyParams(params: AnyParams, record: GadgetRecord<any>): void {\n  const model = getModelByTypename(record.__typename);\n  Object.assign(record, params[model.apiIdentifier], getBelongsToRelationParams(model, params));\n}\n\n/**\n * Get the internal model manager for the model from its maybe-namespaced spot\n */\nexport const internalModelManagerForModel = (api: AnyClient, apiIdentifier: string, namespace: string[]): InternalModelManager => {\n  const modelPath = [...namespace, apiIdentifier];\n  const manager: InternalModelManager | undefined = Globals.platformModules.lodash().get(api, [\"internal\", ...modelPath]);\n  if (!manager) {\n    throw new InternalError(\n      `Gadget needs but can't find an internal model manager for ${modelPath.join(\n        \".\"\n      )} on the API client -- has it finished regenerating or was it recently removed?`\n    );\n  }\n\n  return manager;\n};\n\n/**\n * Get the internal model manager for the model from its maybe-namespaced spot\n */\nexport const internalModelManagerForTypename = (api: AnyClient, typename: string): InternalModelManager => {\n  const model = getModelByTypename(typename);\n\n  return internalModelManagerForModel(api, model.apiIdentifier, model.namespace);\n};\n\n/**\n * Saves record to the database:\n * 1. Checks field validations of a given record, then saves the record to the database.\n * 2. Uses your apps Internal API to persist data. This API quickly interacts with data without running any business logic.\n *\n * @param record - object saved to the database\n */\nexport async function save(record: GadgetRecord<any>): Promise<void> {\n  const context = getCurrentContext();\n  const api = assert(context.api, \"api client is missing from the current context\");\n  const model = getModelByTypename(record.__typename);\n\n  await (await context[kGlobals].modelValidator(model.key)).validate({ api, logger: Globals.logger }, record);\n\n  const internalModelManager = internalModelManagerForTypename(api, record.__typename);\n\n  let result: GadgetRecord<any>;\n\n  if (\"createdAt\" in record && record.createdAt) {\n    result = await internalModelManager.update(record.id, {\n      [model.apiIdentifier]: changedAttributes(model, record),\n    });\n  } else {\n    result = await internalModelManager.create({\n      [model.apiIdentifier]: writableAttributes(model, record),\n    });\n  }\n\n  Object.assign(record, { ...result });\n  record.flushChanges(ChangeTracking.SinceLastPersisted);\n}\n\n/**\n * Deletes record from the database.\n *\n * @param record - object deleted from the database\n */\nexport async function deleteRecord(record: GadgetRecord<any>): Promise<void> {\n  const context = getCurrentContext();\n  const api = assert(context.api, \"api client is missing from the current context\");\n\n  const id = assert(record.id, `record.id not set on record in scope, has the record been persisted?`);\n\n  const internalModelManager = internalModelManagerForTypename(api, record.__typename);\n  await internalModelManager.delete(id);\n\n  if (\"scope\" in context) {\n    context.scope.recordDeleted = true;\n  }\n}\n\nexport function transitionState(\n  record: GadgetRecord<any>,\n  transition: {\n    from?: string | Record<string, string>;\n    to: string | Record<string, string>;\n  }\n): void {\n  const model = getModelByTypename(record.__typename);\n  const isShopifyModel =\n    model.apiIdentifier === \"shopifyShop\" || model.apiIdentifier === \"shopifySync\" || model.apiIdentifier === \"shopifyBulkOperation\";\n\n  if (isShopifyModel && doesVersionSupportSourceControl()) {\n    // In apps framework version 1.0.0+, we handle the state transition internally to Shopify models based on the above API identifiers.\n    // This function becomes a no-op for those models.\n    return;\n  }\n\n  const stringRecordState = typeof record.state === \"string\" ? record.state : JSON.stringify(record.state);\n  const stringTransitionFrom = typeof transition.from === \"string\" ? transition.from : JSON.stringify(transition.from);\n\n  if (transition.from && stringRecordState !== stringTransitionFrom) {\n    throw new InvalidStateTransitionError(undefined, {\n      state: record.state,\n      expectedFrom: transition.from,\n    });\n  }\n\n  record.state = transition.to;\n}\n\nexport function legacySetUser(): void {\n  const context = getActionContextFromLocalStorage();\n\n  if (!context.scope.authenticatedUser) {\n    throw new UserNotSetOnSessionError(\n      \"The authenticated user could not be saved to the session when logging in. Make sure the user has a role assigned to them.\"\n    );\n  }\n  if (!context.session) {\n    throw new NoSessionForAuthenticationError(\n      \"Unable to authenticate because the request was made with no session in context to transition.\"\n    );\n  }\n  context.session.set(\"user\", { [LINK_PARAM]: context.scope.authenticatedUser.id });\n}\n\nexport function legacyUnsetUser(): void {\n  const context = getActionContextFromLocalStorage();\n\n  if (!context.session) {\n    throw new NoSessionForAuthenticationError(\"Unable to unset users on session because the request was made with no session.\");\n  }\n  context.session.delete(\"user\");\n}\n\nexport async function legacySuccessfulAuthentication(params: AnyParams): Promise<void> {\n  const context = getActionContextFromLocalStorage();\n  const { api, scope } = context;\n  const manager = api.internal.user as InternalModelManager;\n\n  const user = (await manager.findMany({ filter: { email: { equals: params.email } } }))[0];\n  let result = false;\n  if (user && params.password && user.password?.hash) {\n    if (await context[kGlobals].platformModules.bcrypt().compare(params.password, user.password.hash)) {\n      scope.authenticatedUser = user;\n      result = true;\n    }\n  }\n  context.logger.info({ email: params.email, userId: user?.id, result }, \"login attempt\");\n\n  if (!result) {\n    throw new Error(\"Invalid email or password\");\n  }\n}\n\n/**\n * @private helper functions and variables\n */\n\nexport function doesVersionSupportSourceControl(): boolean {\n  return Globals.platformModules.compareVersions().satisfies(frameworkVersion, \">=1.0.0\");\n}\n\n/**\n * @private Get action context without `params` and `record` from async local storage.\n */\nexport function getActionContextFromLocalStorage(): AnyActionContext | AnyGlobalActionContext | AnyEffectContext {\n  return assert(actionContextLocalStorage.getStore(), \"this effect function should only be called from within an action\");\n}\n\n/**\n * @private Similar to `getActionContextFromLocalStorage` but returns `undefined` if there is no action context. (i.e. possibly called from a route)\n */\nexport function maybeGetActionContextFromLocalStorage(): AnyActionContext | AnyGlobalActionContext | AnyEffectContext | undefined {\n  return actionContextLocalStorage.getStore();\n}\n\n/**\n * Get the current ambient context in any context\n *\n * @returns The current ambient context, or `undefined` if there is no ambient context.\n * @private\n */\nexport function maybeGetCurrentContext(): AnyActionContext | AnyGlobalActionContext | AnyEffectContext | AnyAmbientContext | undefined {\n  return maybeGetActionContextFromLocalStorage() || Globals.requestContext.get(\"requestContext\");\n}\n\n/**\n * Get the current ambient context in any context\n *\n * @returns The current ambient context, or throws if there is no ambient context.\n * @private\n */\nexport function getCurrentContext(): AnyActionContext | AnyGlobalActionContext | AnyEffectContext | AnyAmbientContext {\n  return assert(maybeGetCurrentContext(), \"no gadget context found in AsyncLocalStorage or on request context\");\n}\n\nexport const LINK_PARAM = \"_link\";\n\nexport function writableAttributes(model: ModelMetadata, record: GadgetRecord<RecordData>): Record<string, any> {\n  const fieldsByApiIdentifier = Globals.platformModules.lodash().keyBy(Object.values(model.fields) as NotYetTyped[], \"apiIdentifier\");\n  return Globals.platformModules.lodash().pickBy(record, (v: any, k: any) => {\n    const field = fieldsByApiIdentifier[k];\n    if (!field) return false;\n\n    const isRelationshipField =\n      field.fieldType === FieldType.HasMany || field.fieldType === FieldType.HasOne || field.fieldType === FieldType.HasManyThrough;\n\n    if (isRelationshipField && v === null) {\n      return false;\n    }\n\n    return field.internalWritable;\n  });\n}\n\nexport function changedAttributes(model: ModelMetadata, record: GadgetRecord<RecordData>): Record<string, any> {\n  const changes = record.changes();\n  const attributes = Object.keys(changes).reduce((attrs, key) => {\n    attrs[key] = record[key];\n    return attrs;\n  }, {} as any);\n  return writableAttributes(model, attributes);\n}\n\nexport const getModelByApiIdentifier = (apiIdentifier: string): ModelMetadata => {\n  const modelListIndexValue = maybeGetCurrentContext()?.[kGlobals]?.modelListIndex ?? modelListIndex;\n  const typename = modelListIndexValue[`api:${apiIdentifier}`];\n  if (!typename) {\n    throw new InternalError(`Model ${apiIdentifier} not found in available model metadata`, {\n      availableApiIdentifiers: Object.keys(modelListIndexValue),\n    });\n  }\n\n  return getModelByTypename(typename);\n};\n\nexport const getModelByTypename = (typename: string): ModelMetadata => {\n  if (!typename) {\n    throw new InternalError(`No typename found on record, __typename must be set for accessing model metadata`);\n  }\n\n  const modelsMapValue = maybeGetCurrentContext()?.[kGlobals]?.modelsMap ?? modelsMap;\n  const model = modelsMapValue[typename];\n  if (!model) {\n    throw new InternalError(`Model with typename ${typename} not found in available model metadata`, {\n      availableTypenames: Object.keys(modelsMapValue),\n    });\n  }\n\n  return model;\n};\n\nexport enum FieldType {\n  ID = \"ID\",\n  Number = \"Number\",\n  String = \"String\",\n  Enum = \"Enum\",\n  RichText = \"RichText\",\n  DateTime = \"DateTime\",\n  Email = \"Email\",\n  URL = \"URL\",\n  Money = \"Money\",\n  File = \"File\",\n  Color = \"Color\",\n  Password = \"Password\",\n  Computed = \"Computed\",\n  HasManyThrough = \"HasManyThrough\",\n  BelongsTo = \"BelongsTo\",\n  HasMany = \"HasMany\",\n  HasOne = \"HasOne\",\n  Boolean = \"Boolean\",\n  Model = \"Model\",\n  Object = \"Object\",\n  Array = \"Array\",\n  JSON = \"JSON\",\n  Code = \"Code\",\n  EncryptedString = \"EncryptedString\",\n  Vector = \"Vector\",\n  /**\n   * Any value at all.\n   * Prefer FieldType.JSON where possible, it's more descriptive.\n   */\n  Any = \"Any\",\n  Null = \"Null\",\n  RecordState = \"RecordState\",\n  RoleAssignments = \"RoleAssignments\",\n}\n"],"names":["FieldType","LINK_PARAM","applyParams","changedAttributes","createGadgetRecord","deleteRecord","doesVersionSupportSourceControl","getActionContextFromLocalStorage","getBelongsToRelationParams","getCurrentContext","getModelByApiIdentifier","getModelByTypename","internalModelManagerForModel","internalModelManagerForTypename","legacySetUser","legacySuccessfulAuthentication","legacyUnsetUser","maybeGetActionContextFromLocalStorage","maybeGetCurrentContext","save","transitionState","writableAttributes","model","params","belongsToParams","field","Object","values","fields","fieldType","modelParams","apiIdentifier","undefined","belongsToParam","belongsToId","id","data","GadgetRecord","__typename","graphqlTypeName","record","assign","api","namespace","modelPath","manager","Globals","platformModules","lodash","get","InternalError","join","typename","context","assert","kGlobals","modelValidator","key","validate","logger","internalModelManager","result","createdAt","update","create","flushChanges","ChangeTracking","SinceLastPersisted","delete","scope","recordDeleted","transition","isShopifyModel","stringRecordState","state","JSON","stringify","stringTransitionFrom","from","InvalidStateTransitionError","expectedFrom","to","authenticatedUser","UserNotSetOnSessionError","session","NoSessionForAuthenticationError","set","internal","user","findMany","filter","email","equals","password","hash","bcrypt","compare","info","userId","Error","compareVersions","satisfies","frameworkVersion","actionContextLocalStorage","getStore","requestContext","fieldsByApiIdentifier","keyBy","pickBy","v","k","isRelationshipField","internalWritable","changes","attributes","keys","reduce","attrs","modelListIndexValue","modelListIndex","availableApiIdentifiers","modelsMapValue","modelsMap","availableTypenames"],"mappings":"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"}