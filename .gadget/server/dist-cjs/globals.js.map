{"version":3,"sources":["/var/gadget/codegen/framework-1756630026360-Css7ce/src/globals.ts"],"sourcesContent":["import type { RequestContext } from \"@fastify/request-context\";\nimport type { AnyClient } from \"@gadgetinc/api-client-core\";\nimport { AsyncLocalStorage } from \"async_hooks\";\nimport type { Logger } from \"./AmbientContext\";\nimport { frameworkVersion, modelListIndex, modelsMap } from \"./metadata\";\nimport type { AnyActionContext, AnyAmbientContext, AnyEffectContext, AnyGlobalActionContext } from \"./types\";\n\nexport const actionContextLocalStorage: AsyncLocalStorage<AnyActionContext | AnyGlobalActionContext | AnyEffectContext> =\n  new AsyncLocalStorage<AnyActionContext | AnyGlobalActionContext | AnyEffectContext>();\n\n/**\n * Extend the @fastify/request-context types with Gadget's added reference to the current unit of work's context\n * See https://github.com/fastify/fastify-request-context#typescript\n * */\ndeclare module \"@fastify/request-context\" {\n  interface RequestContextData {\n    requestContext: AnyAmbientContext | AnyActionContext | AnyGlobalActionContext | AnyEffectContext;\n  }\n}\n\n/** The list of globals that the Gadget harness injects into the framework package */\nexport interface SettableGlobals {\n  logger: Logger;\n  modelValidator: (modelKey: string) => Promise<any>;\n  requestContext: RequestContext;\n  platformRequire: typeof require;\n  api: AnyClient;\n}\n\nexport type GlobalSetter = (globals: SettableGlobals) => void;\n\n/**\n * A container for all the global bits that the gadget-server package needs access to\n * Generally shouldn't be used directly by Gadget app code as the structure is subject to change\n * @internal\n **/\nexport class GadgetFrameworkGlobals {\n  /**\n   * A globally accessible API client instance, set in `set` by the `AppBridge`.\n   * @internal\n   */\n  api: AnyClient = null as any;\n  /**\n   * Internal variable to store the model validator function, set in `set` by the `AppBridge`.\n   * @internal\n   */\n  modelValidator: (modelKey: string) => Promise<any> = null as any;\n  /**\n   * Internal variable to store the request context module, set in `set` by the `AppBridge`.\n   * @internal\n   */\n  requestContext: RequestContext = null as any;\n  /**\n   * A global logger instance that is userVisible and tagged with the platform source.\n   * @internal\n   */\n  logger: Logger = null as any;\n  /**\n   * Require function for importing code from the gadget platform context instead of the app's context.\n   * @internal\n   */\n  platformRequire: typeof require = null as any;\n  /**\n   * This is used internally to set the globals for this instance of the framework package.\n   * @internal\n   */\n  set: GlobalSetter = (globals: SettableGlobals): void => {\n    Object.assign(this, globals);\n  };\n\n  /**\n   * Lazy-loaded modules for use in the framework package from the gadget platform context.\n   * @internal\n   */\n  platformModules: {\n    lodash: () => any;\n    bcrypt: () => any;\n    compareVersions: () => any;\n    klona: () => any;\n  } = {\n    lodash: this._platformModuleRequirer(\"lodash\"),\n    klona: this._platformModuleRequirer(\"klona\"),\n    bcrypt: this._platformModuleRequirer(\"bcrypt\"),\n    compareVersions: this._platformModuleRequirer(\"compare-versions\"),\n  };\n\n  _platformModuleRequirer<T = any>(name: string): () => T {\n    let mod: T = null as any;\n    return () => {\n      if (!mod) {\n        if (!this.platformRequire) throw new Error(\"Globals.platformRequire is not set, has it been injected by the sandbox yet?\");\n        mod = this.platformRequire(name);\n      }\n      return mod;\n    };\n  }\n\n  /** re-export the generated metadata for easy access in the ambient context */\n  modelListIndex = modelListIndex;\n  modelsMap = modelsMap;\n  frameworkVersion = frameworkVersion;\n}\n\nexport const Globals: GadgetFrameworkGlobals = new GadgetFrameworkGlobals();\nexport const kGlobals: unique symbol = Symbol.for(\"gadget/kGlobals\");\n"],"names":["GadgetFrameworkGlobals","Globals","actionContextLocalStorage","kGlobals","AsyncLocalStorage","_platformModuleRequirer","name","mod","platformRequire","Error","api","modelValidator","requestContext","logger","set","globals","Object","assign","platformModules","lodash","klona","bcrypt","compareVersions","modelListIndex","modelsMap","frameworkVersion","Symbol","for"],"mappings":";;;;;;;;;;;IAoCaA,sBAAsB;eAAtBA;;IAmEAC,OAAO;eAAPA;;IAhGAC,yBAAyB;eAAzBA;;IAiGAC,QAAQ;eAARA;;;6BAtGqB;0BAE0B;;;;;;;;;;;;;;AAGrD,MAAMD,4BACX,IAAIE,8BAAiB;AAEvB;;;GAGG,GAOH,mFAAmF,GAWnF;;;;EAIE,GACK,MAAMJ;IAkDXK,wBAAiCC,IAAY,EAAW;QACtD,IAAIC,MAAS;QACb,OAAO;YACL,IAAI,CAACA,KAAK;gBACR,IAAI,CAAC,IAAI,CAACC,eAAe,EAAE,MAAM,IAAIC,MAAM;gBAC3CF,MAAM,IAAI,CAACC,eAAe,CAACF;YAC7B;YACA,OAAOC;QACT;IACF;;QA1DA;;;GAGC,GACDG,uBAAAA,OAAiB;QACjB;;;GAGC,GACDC,uBAAAA,kBAAqD;QACrD;;;GAGC,GACDC,uBAAAA,kBAAiC;QACjC;;;GAGC,GACDC,uBAAAA,UAAiB;QACjB;;;GAGC,GACDL,uBAAAA,mBAAkC;QAClC;;;GAGC,GACDM,uBAAAA,OAAoB,CAACC;YACnBC,OAAOC,MAAM,CAAC,IAAI,EAAEF;QACtB;QAEA;;;GAGC,GACDG,uBAAAA,mBAKI;YACFC,QAAQ,IAAI,CAACd,uBAAuB,CAAC;YACrCe,OAAO,IAAI,CAACf,uBAAuB,CAAC;YACpCgB,QAAQ,IAAI,CAAChB,uBAAuB,CAAC;YACrCiB,iBAAiB,IAAI,CAACjB,uBAAuB,CAAC;QAChD;QAaA,4EAA4E,GAC5EkB,uBAAAA,kBAAiBA,wBAAc;QAC/BC,uBAAAA,aAAYA,mBAAS;QACrBC,uBAAAA,oBAAmBA,0BAAgB;;AACrC;AAEO,MAAMxB,UAAkC,IAAID;AAC5C,MAAMG,WAA0BuB,OAAOC,GAAG,CAAC"}