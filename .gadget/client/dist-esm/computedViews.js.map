{
  "version": 3,
  "sources": ["../src/computedViews.ts"],
  "sourcesContent": ["import { assertOperationSuccess, type GadgetConnection, type VariablesOptions } from \"@gadgetinc/api-client-core\";\nimport { Call, compile, compileWithVariableValues, Var, type Variable } from \"tiny-graphql-query-compiler\";\nimport { variableOptionsToVariables } from \"./utils.js\";\n\n// This is a function that represents a computed view that doesn't take any input parameters/variables.\n// Result is an explicit type parameter defining the shape of the full result.\nexport type ComputedViewFunctionWithoutVariables<Result> = () => Promise<Result>;\n\n// Represents a computed view that doesn't take any input parameters/variables.\n// It includes the view function and the view metadata.\nexport interface ComputedViewWithoutVariables<Result> extends ComputedViewFunctionWithoutVariables<Result> {\n  type: \"computedView\";\n  operationName: string;\n  gqlFieldName: string;\n  namespace: string | string[] | null;\n  resultType: Result;\n  plan(): {\n    query: string;\n    variables: Record<string, any>;\n  };\n}\n\n// This is a function that represents a computed view that takes input parameters/variables.\n// Result is an explicit type parameter defining the shape of the full result.\n// Variables is an explicit type parameter that describes the shape of the variables parameter.\nexport type ComputedViewFunctionWithVariables<Variables, Result> = (variables?: Variables) => Promise<Result>;\n\n// Represents a computed view that takes input parameters/variables.\n// It includes the view function and the view metadata.\nexport interface ComputedViewWithVariables<Variables, Result> extends ComputedViewFunctionWithVariables<Variables, Result> {\n  type: \"computedView\";\n  operationName: string;\n  gqlFieldName: string;\n  namespace: string | string[] | null;\n  variables: VariablesOptions;\n  variablesType: Variables;\n  resultType: Result;\n  plan(variables?: Variables): {\n    query: string;\n    variables: Record<string, any>;\n  };\n}\n\nexport const computedViewOperation = (\n  gqlFieldName: string,\n  variablesOptions: VariablesOptions = {},\n  namespace?: string | string[] | null\n): {\n  query: string;\n  variables: Record<string, any>;\n} => {\n  let fields = {\n    [gqlFieldName]: Call(variableOptionsToVariables(variablesOptions)),\n  };\n\n  if (namespace) {\n    fields = namespacify(namespace, fields);\n  }\n\n  return variablesOptions\n    ? compileWithVariableValues({ type: \"query\", name: gqlFieldName, fields })\n    : { query: compile({ type: \"query\", name: gqlFieldName, fields }), variables: {} };\n};\n\nexport const computedViewRunner = async (\n  connection: GadgetConnection,\n  gqlFieldName: string,\n  variablesOptions?: VariablesOptions,\n  namespace?: string | string[] | null\n): Promise<any> => {\n  const { query, variables } = computedViewOperation(gqlFieldName, variablesOptions, namespace);\n  const response = await connection.currentClient.query(query, variables);\n  const dataPath = namespaceDataPath([gqlFieldName], namespace);\n  return assertOperationSuccess(response, dataPath);\n};\n\nexport const inlineComputedViewOperation = (\n  query: string,\n  gqlFieldName: string,\n  variables?: Record<string, any>,\n  namespace?: string | string[] | null\n): {\n  query: string;\n  variables: Record<string, any>;\n} => {\n  const vars: Record<string, Variable> = {\n    query: Var({ type: \"String\", value: query, required: true }),\n  };\n  if (variables) vars[\"variables\"] = Var({ type: \"JSONObject\", value: variables });\n  let fields = {\n    [gqlFieldName]: Call(variableOptionsToVariables(vars)),\n  };\n  if (namespace) fields = namespacify(namespace, fields);\n  return compileWithVariableValues({ type: \"query\", name: gqlFieldName, fields });\n};\n\nexport const inlineComputedViewRunner = async (\n  connection: GadgetConnection,\n  gqlFieldName: string,\n  viewQuery: string,\n  variables?: Record<string, any>,\n  namespace?: string | string[] | null\n): Promise<unknown> => {\n  const { query, variables: vars } = inlineComputedViewOperation(viewQuery, gqlFieldName, variables, namespace);\n  const response = await connection.currentClient.query(query, vars);\n  const dataPath = namespaceDataPath([gqlFieldName], namespace);\n  return assertOperationSuccess(response, dataPath);\n};\n\n/**\n * Had to duplicate these from api-client-core to make 0.15.20 tests happy,\n * Hopefully we can get rid of this duplication at some point\n *\n * Wrap a field selection in a set of namespaces\n **/\nfunction namespacify(namespace: string[] | string | undefined | null, fields: any) {\n  if (!namespace) return fields;\n  if (!Array.isArray(namespace)) {\n    namespace = [namespace];\n  }\n  if (namespace) {\n    for (let i = namespace.length - 1; i >= 0; i--) {\n      fields = {\n        [namespace[i]]: fields,\n      };\n    }\n  }\n  return fields;\n}\n\nconst namespaceDataPath = (dataPath: string[], namespace?: string[] | string | null) => {\n  if (namespace) {\n    dataPath.unshift(...(Array.isArray(namespace) ? namespace : [namespace]));\n  }\n  return dataPath;\n};\n"],
  "mappings": "AAAA,SAAS,8BAA4E;AACrF,SAAS,MAAM,SAAS,2BAA2B,WAA0B;AAC7E,SAAS,kCAAkC;AAyCpC,MAAM,wBAAwB,CACnC,cACA,mBAAqC,CAAC,GACtC,cAIG;AACH,MAAI,SAAS;AAAA,IACX,CAAC,YAAY,GAAG,KAAK,2BAA2B,gBAAgB,CAAC;AAAA,EACnE;AAEA,MAAI,WAAW;AACb,aAAS,YAAY,WAAW,MAAM;AAAA,EACxC;AAEA,SAAO,mBACH,0BAA0B,EAAE,MAAM,SAAS,MAAM,cAAc,OAAO,CAAC,IACvE,EAAE,OAAO,QAAQ,EAAE,MAAM,SAAS,MAAM,cAAc,OAAO,CAAC,GAAG,WAAW,CAAC,EAAE;AACrF;AAEO,MAAM,qBAAqB,OAChC,YACA,cACA,kBACA,cACiB;AACjB,QAAM,EAAE,OAAO,UAAU,IAAI,sBAAsB,cAAc,kBAAkB,SAAS;AAC5F,QAAM,WAAW,MAAM,WAAW,cAAc,MAAM,OAAO,SAAS;AACtE,QAAM,WAAW,kBAAkB,CAAC,YAAY,GAAG,SAAS;AAC5D,SAAO,uBAAuB,UAAU,QAAQ;AAClD;AAEO,MAAM,8BAA8B,CACzC,OACA,cACA,WACA,cAIG;AACH,QAAM,OAAiC;AAAA,IACrC,OAAO,IAAI,EAAE,MAAM,UAAU,OAAO,OAAO,UAAU,KAAK,CAAC;AAAA,EAC7D;AACA,MAAI;AAAW,SAAK,WAAW,IAAI,IAAI,EAAE,MAAM,cAAc,OAAO,UAAU,CAAC;AAC/E,MAAI,SAAS;AAAA,IACX,CAAC,YAAY,GAAG,KAAK,2BAA2B,IAAI,CAAC;AAAA,EACvD;AACA,MAAI;AAAW,aAAS,YAAY,WAAW,MAAM;AACrD,SAAO,0BAA0B,EAAE,MAAM,SAAS,MAAM,cAAc,OAAO,CAAC;AAChF;AAEO,MAAM,2BAA2B,OACtC,YACA,cACA,WACA,WACA,cACqB;AACrB,QAAM,EAAE,OAAO,WAAW,KAAK,IAAI,4BAA4B,WAAW,cAAc,WAAW,SAAS;AAC5G,QAAM,WAAW,MAAM,WAAW,cAAc,MAAM,OAAO,IAAI;AACjE,QAAM,WAAW,kBAAkB,CAAC,YAAY,GAAG,SAAS;AAC5D,SAAO,uBAAuB,UAAU,QAAQ;AAClD;AAQA,SAAS,YAAY,WAAiD,QAAa;AACjF,MAAI,CAAC;AAAW,WAAO;AACvB,MAAI,CAAC,MAAM,QAAQ,SAAS,GAAG;AAC7B,gBAAY,CAAC,SAAS;AAAA,EACxB;AACA,MAAI,WAAW;AACb,aAAS,IAAI,UAAU,SAAS,GAAG,KAAK,GAAG,KAAK;AAC9C,eAAS;AAAA,QACP,CAAC,UAAU,CAAC,CAAC,GAAG;AAAA,MAClB;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAEA,MAAM,oBAAoB,CAAC,UAAoB,cAAyC;AACtF,MAAI,WAAW;AACb,aAAS,QAAQ,GAAI,MAAM,QAAQ,SAAS,IAAI,YAAY,CAAC,SAAS,CAAE;AAAA,EAC1E;AACA,SAAO;AACT;",
  "names": []
}
